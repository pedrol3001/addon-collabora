#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Collabora
# Collabora init script, runs before any other service
# ==============================================================================

bashio::log.info "Configuring Collabora..."

rm -f /etc/coolwsd/coolwsd.xml

# Ensure configuration file server directory exists
if ! bashio::fs.directory_exists '/config/coolwsd'; then
    mkdir -p /config/coolwsd || bashio::exit.nok "Failed to create n8n configuration directory"
fi

bashio::var.json \
  ssl "^$(bashio::config 'ssl')" \
  public_url "$(bashio::config 'public_url')" \
  log_level "$(bashio::config 'log_level')" \
  | tempio \
    -template /etc/collabora/config.gtpl \
    -out /etc/coolwsd/coolwsd.xml

if [ "$(bashio::config 'log_level')" == "debug" ]; then
  bashio::log.info "$(cat /etc/coolwsd/coolwsd.xml)"
fi
